<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WonderLang Data Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        .console-container { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; height: 300px; overflow-y: auto; text-align: left; }
        .log-error { color: #ff5555; }
        .log-warn { color: #ffaa00; }
        .log-success { color: #55ff55; }
        .log-info { color: #aaaaaa; }
        th { user-select: none; }
        th:hover { background-color: #e5e7eb; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.5); }
        /* Style for multiselect to make it look clean */
        select[multiple] { scrollbar-width: thin; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">

    <nav class="bg-white shadow-sm mb-6">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="text-xl font-bold text-gray-800">WonderLang Reporting</div>
                <div class="flex space-x-6">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active pb-1 px-2">Dashboard</button>
                    <button onclick="switchTab('sync')" id="tab-sync" class="text-gray-500 hover:text-blue-500 pb-1 px-2">Data Sync</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4">
        
        <div id="view-dashboard">
            <div class="bg-white p-5 rounded-lg shadow-sm mb-6 flex flex-wrap gap-4 items-start">
                
                <div class="flex flex-col gap-1">
                    <label class="text-sm font-medium text-gray-600">From Date</label>
                    <input type="date" id="dash-start" class="border rounded p-2 text-sm w-36">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-sm font-medium text-gray-600">To Date</label>
                    <input type="date" id="dash-end" class="border rounded p-2 text-sm w-36">
                </div>
                
                <div class="flex flex-col gap-1">
                    <label class="text-sm font-medium text-gray-600">Country / Region</label>
                    <select id="dash-country" class="border rounded p-2 text-sm w-56">
                        <option value="ALL">All Locations</option>
                    </select>
                </div>

                <div class="flex flex-col gap-1">
                    <label class="text-sm font-medium text-gray-600">Exclude Ad Sets <span class="text-[10px] text-gray-400 font-normal">(Ctrl/Cmd+Click)</span></label>
                    <select id="dash-exclude-adsets" multiple class="border rounded p-2 text-sm w-64 h-20 bg-white shadow-inner">
                        </select>
                </div>

                <div class="flex flex-col gap-1 bg-gray-50 p-2 rounded border w-72">
                    <label class="text-sm font-medium text-gray-600">Exclude Dates</label>
                    <div id="exclude-date-rows" class="flex flex-col gap-1 max-h-20 overflow-y-auto">
                        </div>
                    <button onclick="addExcludeRow()" class="text-xs text-blue-600 font-medium hover:underline text-left mt-1">+ Add Date Range</button>
                </div>

                <div class="flex flex-col gap-2 ml-auto mt-6 items-end">
                    <div class="flex gap-2">
                        <button onclick="openRegionModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 transition text-sm">
                            ‚öôÔ∏è Regions
                        </button>
                        <button onclick="loadDashboardData()" class="bg-blue-600 text-white px-5 py-2 rounded shadow hover:bg-blue-700 transition text-sm font-bold">
                            Load Data
                        </button>
                    </div>
                    <button onclick="copyForGemini()" id="btn-copy-gemini" class="bg-indigo-100 text-indigo-700 border border-indigo-300 px-4 py-1.5 rounded shadow-sm hover:bg-indigo-200 transition text-sm w-full text-center font-medium">
                        üìã Copy data for Gemini
                    </button>
                    <div class="text-xs text-gray-400 text-right mt-1">
                        *Net deducts Steam 30% & 12.5% Tax
                    </div>
                </div>

            </div>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-red-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">Meta Ad Spend</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-spend">‚Ç¨0.00</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">Net Revenue</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-net">‚Ç¨0.00</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">Subscribers</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-subs">0</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-yellow-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">Cost Per Sub</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-cps">‚Ç¨0.00</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-purple-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">ROAS</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-roas">0.00x</div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-6">
                <canvas id="mainChart" height="80"></canvas>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-10 overflow-x-auto">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Regional Performance Breakdown</h3>
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-sm text-gray-600">
                            <th class="p-3 cursor-pointer" onclick="sortTable('countryName')">Country / Region ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('spend')">Ad Spend ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('net')">Net Revenue ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('subs')">Subscribers ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('cps')">Cost / Sub ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('roas')">ROAS ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('cpm')">CPM ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('cpc')">CPC ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="country-table-body" class="text-sm">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="view-sync" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <h2 class="text-lg font-bold mb-4">Manual ETL Triggers</h2>
                <div class="flex gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Fetch Data From:</label>
                        <input type="date" id="since" class="border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">To:</label>
                        <input type="date" id="until" class="border rounded p-2 text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <button onclick="triggerUpdate('refresh')" class="bg-gray-800 text-white py-2 rounded hover:bg-black transition">Update ALL</button>
                    <button onclick="triggerUpdate('fetch-stripe')" class="bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">Stripe</button>
                    <button onclick="triggerUpdate('fetch-meta')" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Meta Ads</button>
                    <button onclick="triggerUpdate('fetch-tiktok')" class="bg-black text-white py-2 rounded hover:bg-gray-800 transition">TikTok Ads</button>
                    <button onclick="triggerUpdate('fetch-mailerlite')" class="bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">MailerLite</button>
                    <button onclick="triggerUpdate('fetch-steam-sales')" class="bg-gray-600 text-white py-2 rounded hover:bg-gray-700 transition">Steam</button>
                </div>
            </div>
            <h3 class="font-bold text-gray-700 mb-2">Terminal Output</h3>
            <div class="console-container mb-10" id="console">
                <div class="log-info">System ready. Awaiting commands...</div>
            </div>
        </div>

    </div>

    <div id="region-modal" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-2">Manage Regions</h3>
            <p class="text-xs text-gray-500 mb-4">Format: <code>Region Name = CC, CC</code>. A country can be in multiple regions.</p>
            <textarea id="region-text" class="w-full border rounded p-2 text-sm font-mono h-40 mb-4" placeholder="DACH = DE, AT, CH&#10;Francophone = FR, BE, CH"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeRegionModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="saveRegions()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save & Reload</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Real Country Names API ---
        const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
        
        function getCountryName(code) {
            if (!code || code === 'UNKNOWN') return 'Unknown / Unattributed';
            try { return regionNames.of(code) || code; } catch (e) { return code; }
        }

        // --- 2. Dynamic Region Management ---
        let REGIONS = {};
        const DEFAULT_REGIONS = "DACH = DE, AT, CH\nNorth America = US, CA\nUK = GB, UK\nFrancophone = FR, BE, CH\nHispanophone = ES, MX, AR";

        function loadRegions() {
            const saved = localStorage.getItem('wl-regions') || DEFAULT_REGIONS;
            document.getElementById('region-text').value = saved;
            
            REGIONS = {}; 
            saved.split('\n').forEach(line => {
                if (!line.includes('=')) return;
                const [regName, codes] = line.split('=');
                codes.split(',').forEach(c => {
                    const cleanCode = c.trim().toUpperCase();
                    if (!REGIONS[cleanCode]) REGIONS[cleanCode] = [];
                    REGIONS[cleanCode].push(regName.trim());
                });
            });
        }

        function openRegionModal() { document.getElementById('region-modal').classList.remove('hidden'); }
        function closeRegionModal() { document.getElementById('region-modal').classList.add('hidden'); }
        function saveRegions() {
            localStorage.setItem('wl-regions', document.getElementById('region-text').value);
            closeRegionModal();
            loadRegions();
            loadDashboardData(); 
        }
        loadRegions();

        // --- 3. Exclude Dates UI & Logic ---
        function addExcludeRow(start = '', end = '') {
            const container = document.getElementById('exclude-date-rows');
            const rowId = 'excl-' + Date.now() + Math.floor(Math.random() * 1000);
            const div = document.createElement('div');
            div.id = rowId;
            div.className = "flex items-center gap-1";
            div.innerHTML = `
                <input type="date" class="exclude-start border rounded p-1 text-xs w-[110px]" value="${start}">
                <span class="text-gray-400 text-xs">to</span>
                <input type="date" class="exclude-end border rounded p-1 text-xs w-[110px]" value="${end}">
                <button onclick="document.getElementById('${rowId}').remove()" class="text-red-500 font-bold px-1.5 hover:bg-red-100 rounded">√ó</button>
            `;
            container.appendChild(div);
        }

        function getExcludedDateRanges() {
            const ranges = [];
            document.querySelectorAll('#exclude-date-rows > div').forEach(row => {
                const s = row.querySelector('.exclude-start').value;
                const e = row.querySelector('.exclude-end').value;
                if (s || e) {
                    ranges.push({
                        start: s || '2000-01-01',
                        end: e || '2099-12-31'
                    });
                }
            });
            return ranges;
        }

        function isDateExcluded(dStr, excludeRanges) {
            return excludeRanges.some(r => dStr >= r.start && dStr <= r.end);
        }

        // --- 4. Rank-Based Heatmap Logic ---
        function getRankColor(val, sortedArr, goodIsHigh) {
            if (!val || val <= 0 || sortedArr.length === 0) return 'transparent';
            if (sortedArr.length === 1) return 'hsl(60, 80%, 85%)'; 
            const index = sortedArr.indexOf(val);
            if (index === -1) return 'transparent';
            let ratio = index / (sortedArr.length - 1); 
            if (!goodIsHigh) ratio = 1 - ratio; 
            const hue = ratio * 120;
            return `hsl(${hue}, 80%, 85%)`; 
        }

        // --- UI Tabs ---
        function switchTab(tab) {
            document.getElementById('view-dashboard').classList.toggle('hidden', tab !== 'dashboard');
            document.getElementById('view-sync').classList.toggle('hidden', tab !== 'sync');
            document.getElementById('tab-dashboard').classList.toggle('text-gray-500', tab !== 'dashboard');
            document.getElementById('tab-dashboard').classList.toggle('tab-active', tab === 'dashboard');
            document.getElementById('tab-sync').classList.toggle('text-gray-500', tab !== 'sync');
            document.getElementById('tab-sync').classList.toggle('tab-active', tab === 'sync');
        }

        // --- Dashboard Logic ---
        const SHEET_ID = '15zn0MHwsfkG20eBvEQmFb4BdTto2xEM9z2RAKtfgDow';
        const TAX_RATE = 0.125;
        const STEAM_CUT = 0.30;
        const RATES = { 
            'usd': 0.92, 'eur': 1.0, 'gbp': 1.17, 
            'jpy': 0.0061, 'krw': 0.00069, 'aud': 0.60, 
            'cad': 0.68, 'chf': 1.06, 'cny': 0.13, 
            'brl': 0.18, 'mxn': 0.054, 'inr': 0.011 
        };
        
        function toEur(amount, curr) { return amount * (RATES[(curr || 'eur').toLowerCase()] || 1); }

        let myChart = null;
        let countryAggData = []; 
        let currentSort = { col: 'roas', desc: true }; 
        let globalDashboardState = {};

        async function fetchSheet(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
            return new Promise((resolve) => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: () => resolve([])
                });
            });
        }

        function normalizeDate(dStr) {
            if (!dStr) return null;
            if (dStr.includes('/')) {
                const parts = dStr.split('/');
                if (parts.length === 3) return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
            }
            return dStr.substring(0, 10);
        }

        async function loadDashboardData() {
            const btn = document.querySelector('button[onclick="loadDashboardData()"]');
            btn.innerText = "Loading...";
            
            const [meta, steam, stripe, paypal, mailerlite] = await Promise.all([
                fetchSheet('Meta'), fetchSheet('Steam_Sales'), fetchSheet('Stripe'), fetchSheet('Paypal'), fetchSheet('MailerLite')
            ]);

            const startDate = document.getElementById('dash-start').value || "2000-01-01";
            const endDate = document.getElementById('dash-end').value || "2099-12-31";
            const filterSelection = document.getElementById('dash-country').value;
            const excludedRanges = getExcludedDateRanges();
            
            // Populate and read Ad Set Exclusions
            const adsetSelect = document.getElementById('dash-exclude-adsets');
            const excludeAdsets = Array.from(adsetSelect.selectedOptions).map(opt => opt.value);
            
            // Build unique list of Ad Sets to populate dropdown
            const uniqueAdsets = [...new Set(meta.map(r => r.adset_name).filter(Boolean))].sort();
            adsetSelect.innerHTML = ''; // clear out old options
            uniqueAdsets.forEach(adset => {
                const opt = new Option(adset, adset);
                if (excludeAdsets.includes(adset)) opt.selected = true; // Retain user selection
                adsetSelect.add(opt);
            });

            globalDashboardState = { startDate, endDate, filterSelection, excludeAdsets, excludedRanges };

            let totalSpend = 0, totalNet = 0, totalSubs = 0, totalImpressions = 0, totalClicks = 0;
            const dailyData = {}; 
            const countryAgg = {}; 
            const dropdownOptions = new Set();

            const addMetric = (date, metric, val, countryCode) => {
                if (!date || isNaN(val)) return;
                const d = normalizeDate(date);
                const cCode = (countryCode || 'UNKNOWN').toUpperCase();
                
                const regionNames = REGIONS[cCode] || [];

                if (cCode !== 'UNKNOWN') dropdownOptions.add(cCode);
                regionNames.forEach(rn => dropdownOptions.add(`REGION:${rn}`));

                let isFilteredIn = false;
                if (filterSelection === 'ALL') {
                    isFilteredIn = true;
                } else if (filterSelection.startsWith('REGION:')) {
                    const targetRegion = filterSelection.replace('REGION:', '');
                    isFilteredIn = regionNames.includes(targetRegion);
                } else {
                    isFilteredIn = (cCode === filterSelection);
                }

                if (d >= startDate && d <= endDate && isFilteredIn && !isDateExcluded(d, excludedRanges)) {
                    if (!dailyData[d]) dailyData[d] = { spend: 0, net: 0, subs: 0, impressions: 0, clicks: 0 };
                    dailyData[d][metric] += val;
                    
                    if (!countryAgg[cCode]) countryAgg[cCode] = { 
                        country: cCode, 
                        countryName: getCountryName(cCode), 
                        region: regionNames.length > 0 ? regionNames.join(', ') : 'Other', 
                        spend: 0, net: 0, subs: 0, impressions: 0, clicks: 0 
                    };
                    countryAgg[cCode][metric] += val;
                    
                    if (metric === 'spend') totalSpend += val;
                    if (metric === 'net') totalNet += val;
                    if (metric === 'subs') totalSubs += val;
                    if (metric === 'impressions') totalImpressions += val;
                    if (metric === 'clicks') totalClicks += val;
                }
            };

            // Process Meta with Ad Set Filtering + Impressions/Clicks
            meta.forEach(r => {
                const adsetName = r.adset_name || '';
                if (!excludeAdsets.includes(adsetName)) {
                    addMetric(r.date, 'spend', parseFloat(r.spend || 0), r.country);
                    addMetric(r.date, 'impressions', parseInt(r.impressions || 0), r.country);
                    addMetric(r.date, 'clicks', parseInt(r.clicks || 0), r.country);
                }
            });

            mailerlite.forEach(r => addMetric(r.created_at, 'subs', 1, r.country));
            
            steam.forEach(r => {
                const eurRev = toEur(parseFloat(r.net_revenue || 0), 'usd');
                addMetric(r.date, 'net', eurRev * (1 - STEAM_CUT) * (1 - TAX_RATE), r.country);
            });
            
            stripe.forEach(r => {
                if (r.status === 'unpaid') return;
                const curr = (r.currency || 'eur').toLowerCase();
                const isZeroDecimal = ['jpy', 'krw', 'vnd', 'clp', 'pyg'].includes(curr);
                const amt = isZeroDecimal ? parseFloat(r.amount || 0) : (parseFloat(r.amount || 0) / 100);
                const eurRev = toEur(amt, curr);
                addMetric(r.created_at, 'net', eurRev * (1 - TAX_RATE), r.country);
            });
            
            paypal.forEach(r => {
                const amt = toEur(parseFloat(r.amout || r.amount || 0), r.currency);
                addMetric(r.date, 'net', amt * (1 - TAX_RATE), r.country);
            });

            // Update Dropdown Filter
            const select = document.getElementById('dash-country');
            const currentFilter = select.value;
            select.innerHTML = '<option value="ALL">All Locations</option>';
            
            const regionsList = [];
            const countriesList = [];
            dropdownOptions.forEach(opt => {
                if (opt.startsWith('REGION:')) regionsList.push(opt);
                else countriesList.push(opt);
            });
            
            regionsList.sort().forEach(opt => select.add(new Option(`üåç ${opt.replace('REGION:', '')} (Region)`, opt)));
            countriesList.sort((a, b) => getCountryName(a).localeCompare(getCountryName(b))).forEach(opt => {
                select.add(new Option(`üá∫üá≥ ${getCountryName(opt)}`, opt));
            });
            select.value = currentFilter || 'ALL';

            // Update KPIs
            document.getElementById('kpi-spend').innerText = `‚Ç¨${totalSpend.toFixed(2)}`;
            document.getElementById('kpi-net').innerText = `‚Ç¨${totalNet.toFixed(2)}`;
            document.getElementById('kpi-subs').innerText = totalSubs;
            document.getElementById('kpi-cps').innerText = totalSubs > 0 ? `‚Ç¨${(totalSpend / totalSubs).toFixed(2)}` : '‚Ç¨0.00';
            document.getElementById('kpi-roas').innerText = totalSpend > 0 ? (totalNet / totalSpend).toFixed(2) + 'x' : '0.00x';

            // Prepare Table Data (Calculate CPM/CPC here)
            countryAggData = Object.values(countryAgg).map(c => {
                c.cps = c.subs > 0 ? c.spend / c.subs : 0;
                c.roas = c.spend > 0 ? c.net / c.spend : 0;
                c.cpm = c.impressions > 0 ? (c.spend / c.impressions) * 1000 : 0;
                c.cpc = c.clicks > 0 ? c.spend / c.clicks : 0;
                return c;
            }).filter(c => c.spend > 0 || c.net > 0 || c.subs > 0);

            renderTable();

            // Render Chart
            const sortedDates = Object.keys(dailyData).sort();
            const spendData = sortedDates.map(d => dailyData[d].spend);
            const roasData = sortedDates.map(d => dailyData[d].spend > 0 ? (dailyData[d].net / dailyData[d].spend) : 0);
            const cpsData = sortedDates.map(d => dailyData[d].subs > 0 ? (dailyData[d].spend / dailyData[d].subs) : 0);

            if (myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [
                        { type: 'bar', label: 'Ad Spend (‚Ç¨)', data: spendData, backgroundColor: 'rgba(248, 113, 113, 0.7)', yAxisID: 'y' },
                        { type: 'line', label: 'ROAS (x)', data: roasData, borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', fill: false, tension: 0.3, yAxisID: 'y1' },
                        { type: 'line', label: 'Cost / Sub (‚Ç¨)', data: cpsData, borderColor: '#facc15', backgroundColor: 'rgba(250, 204, 21, 0.1)', fill: false, tension: 0.3, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Ad Spend (‚Ç¨)'} },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Ratios (ROAS & Cost/Sub)'} }
                    }
                }
            });

            globalDashboardState.totalSpend = totalSpend;
            globalDashboardState.totalNet = totalNet;
            globalDashboardState.totalSubs = totalSubs;
            globalDashboardState.totalImpressions = totalImpressions;
            globalDashboardState.totalClicks = totalClicks;

            btn.innerText = "Load Data";
        }

        function sortTable(col) {
            if (currentSort.col === col) currentSort.desc = !currentSort.desc;
            else { currentSort.col = col; currentSort.desc = true; }
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('country-table-body');
            const col = currentSort.col;
            const dir = currentSort.desc ? -1 : 1;

            countryAggData.sort((a, b) => {
                if (typeof a[col] === 'string') return a[col].localeCompare(b[col]) * dir;
                if (a[col] < b[col]) return -1 * dir;
                if (a[col] > b[col]) return 1 * dir;
                return 0;
            });

            const sortedRoas = countryAggData.filter(c => c.roas > 0).map(c => c.roas).sort((a,b) => a - b);
            const sortedCps = countryAggData.filter(c => c.cps > 0).map(c => c.cps).sort((a,b) => a - b);
            const sortedCpm = countryAggData.filter(c => c.cpm > 0).map(c => c.cpm).sort((a,b) => a - b);
            const sortedCpc = countryAggData.filter(c => c.cpc > 0).map(c => c.cpc).sort((a,b) => a - b);

            tbody.innerHTML = countryAggData.map(c => {
                const roasColor = getRankColor(c.roas, sortedRoas, true);
                const cpsColor = c.subs > 0 ? getRankColor(c.cps, sortedCps, false) : 'transparent';
                const cpmColor = c.impressions > 0 ? getRankColor(c.cpm, sortedCpm, false) : 'transparent';
                const cpcColor = c.clicks > 0 ? getRankColor(c.cpc, sortedCpc, false) : 'transparent';
                
                const regionTag = c.region !== 'Other' ? `<span class="text-xs text-blue-500 font-bold ml-1">[${c.region}]</span>` : '';

                return `
                <tr class="border-b transition hover:bg-gray-100">
                    <td class="p-3 text-gray-800">
                        <span class="font-medium">${c.countryName}</span> 
                        <span class="text-xs text-gray-400 ml-1">(${c.country})</span>
                        ${regionTag}
                    </td>
                    <td class="p-3 text-right text-red-600">‚Ç¨${c.spend.toFixed(2)}</td>
                    <td class="p-3 text-right text-green-600">‚Ç¨${c.net.toFixed(2)}</td>
                    <td class="p-3 text-right text-blue-600 font-bold">${c.subs}</td>
                    <td class="p-3 text-right text-gray-800 font-medium" style="background-color: ${cpsColor}">‚Ç¨${c.cps.toFixed(2)}</td>
                    <td class="p-3 text-right text-gray-800 font-bold" style="background-color: ${roasColor}">${c.roas.toFixed(2)}x</td>
                    <td class="p-3 text-right text-gray-600 text-xs" style="background-color: ${cpmColor}">‚Ç¨${c.cpm.toFixed(2)}</td>
                    <td class="p-3 text-right text-gray-600 text-xs" style="background-color: ${cpcColor}">‚Ç¨${c.cpc.toFixed(2)}</td>
                </tr>
            `}).join('');
        }

        function copyForGemini() {
            const btn = document.getElementById('btn-copy-gemini');
            
            const exDates = globalDashboardState.excludedRanges.map(r => `${r.start} to ${r.end}`).join(', ') || 'None';
            const exAds = globalDashboardState.excludeAdsets.join(', ') || 'None';
            const cps = globalDashboardState.totalSubs > 0 ? (globalDashboardState.totalSpend / globalDashboardState.totalSubs).toFixed(2) : '0.00';
            const roas = globalDashboardState.totalSpend > 0 ? (globalDashboardState.totalNet / globalDashboardState.totalSpend).toFixed(2) : '0.00';
            
            const globalCpm = globalDashboardState.totalImpressions > 0 ? (globalDashboardState.totalSpend / globalDashboardState.totalImpressions) * 1000 : 0;
            const globalCpc = globalDashboardState.totalClicks > 0 ? globalDashboardState.totalSpend / globalDashboardState.totalClicks : 0;

            let output = `## WonderLang Ad Spend & Revenue Analysis\n\n`;
            output += `### Dashboard Filter State\n`;
            output += `- **Date Range:** ${globalDashboardState.startDate} to ${globalDashboardState.endDate}\n`;
            output += `- **Excluded Dates:** ${exDates}\n`;
            output += `- **Excluded Ad Sets:** ${exAds}\n`;
            output += `- **Country Filter:** ${globalDashboardState.filterSelection}\n\n`;

            output += `### Top-Level KPIs\n`;
            output += `- **Total Ad Spend:** ‚Ç¨${globalDashboardState.totalSpend.toFixed(2)}\n`;
            output += `- **Total Net Revenue:** ‚Ç¨${globalDashboardState.totalNet.toFixed(2)}\n`;
            output += `- **New Subscribers:** ${globalDashboardState.totalSubs}\n`;
            output += `- **Cost per Sub:** ‚Ç¨${cps}\n`;
            output += `- **ROAS:** ${roas}x\n`;
            output += `- **Global CPM:** ‚Ç¨${globalCpm.toFixed(2)}\n`;
            output += `- **Global CPC:** ‚Ç¨${globalCpc.toFixed(2)}\n\n`;

            output += `### Regional Performance Breakdown\n`;
            output += `| Country | Region | Ad Spend (‚Ç¨) | Net Rev (‚Ç¨) | Subs | Cost/Sub (‚Ç¨) | ROAS (x) | CPM (‚Ç¨) | CPC (‚Ç¨) |\n`;
            output += `|---------|--------|--------------|-------------|------|--------------|----------|---------|---------|\n`;

            countryAggData.forEach(c => {
                output += `| ${c.countryName} (${c.country}) | ${c.region} | ${c.spend.toFixed(2)} | ${c.net.toFixed(2)} | ${c.subs} | ${c.cps.toFixed(2)} | ${c.roas.toFixed(2)} | ${c.cpm.toFixed(2)} | ${c.cpc.toFixed(2)} |\n`;
            });

            navigator.clipboard.writeText(output).then(() => {
                const oldText = btn.innerText;
                btn.innerText = "‚úÖ Copied to clipboard!";
                btn.classList.replace('bg-indigo-100', 'bg-green-100');
                btn.classList.replace('text-indigo-700', 'text-green-700');
                
                setTimeout(() => {
                    btn.innerText = oldText;
                    btn.classList.replace('bg-green-100', 'bg-indigo-100');
                    btn.classList.replace('text-green-700', 'text-indigo-700');
                }, 3000);
            });
        }

        window.onload = () => {
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setDate(today.getDate() - 30);
            document.getElementById('dash-end').value = today.toISOString().split('T')[0];
            document.getElementById('dash-start').value = lastMonth.toISOString().split('T')[0];
            
            addExcludeRow();
            loadDashboardData();
        };

        // --- ETL Sync Logic ---
        function logToConsole(message, type = 'info') {
            const consoleDiv = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const msgDiv = document.createElement('div');
            msgDiv.className = `log-${type}`;
            const text = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
            msgDiv.innerText = `[${time}] ${text}`;
            consoleDiv.appendChild(msgDiv);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        async function triggerUpdate(endpoint) {
            const buttons = document.querySelectorAll('#view-sync button');
            const sinceVal = document.getElementById('since').value;
            const untilVal = document.getElementById('until').value;
            
            buttons.forEach(btn => btn.disabled = true);
            logToConsole(`>>> Starting ${endpoint.toUpperCase()}...`, 'warn');

            const payload = {};
            if (sinceVal) payload.since = new Date(sinceVal).toISOString();
            if (untilVal) payload.until = new Date(untilVal).toISOString();

            try {
                const response = await fetch(`/.netlify/functions/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (response.ok) {
                    if (result.logs) result.logs.forEach(l => logToConsole(l.msg, l.type));
                    if (endpoint === 'refresh' && result.results) {
                        for (const [source, data] of Object.entries(result.results)) {
                            if (data && data.ok === false) logToConsole(`[${source.toUpperCase()}] ERROR: ${data.msg}`, 'error');
                            else logToConsole(`[${source.toUpperCase()}] SUCCESS: Added ${data?.rows || 0} rows`, 'success');
                        }
                    } else if (result.ok === false) logToConsole(`ERROR: ${result.msg}`, 'error');
                    else logToConsole(`SUCCESS: Transferred ${result.rows || 0} rows to Sheets.`, 'success');
                } else logToConsole(`HTTP ERROR: ${result.error || response.statusText}`, 'error');
            } catch (error) { logToConsole(`NETWORK ERROR: ${error.message}`, 'error'); } 
            finally { buttons.forEach(btn => btn.disabled = false); logToConsole(`<<< ${endpoint.toUpperCase()} finished.`, 'warn'); }
        }
    </script>
</body>
</html>
