<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WonderLang Data Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        .console-container { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; height: 300px; overflow-y: auto; text-align: left; }
        .log-error { color: #ff5555; }
        .log-warn { color: #ffaa00; }
        .log-success { color: #55ff55; }
        .log-info { color: #aaaaaa; }
        th { user-select: none; }
        th:hover { background-color: #e5e7eb; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.5); }
        select[multiple] { scrollbar-width: thin; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">

    <nav class="bg-white shadow-sm mb-6">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="text-xl font-bold text-gray-800">WonderLang Reporting</div>
                <div class="flex space-x-6">
                    <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active pb-1 px-2">Dashboard</button>
                    <button onclick="switchTab('funnel')" id="tab-funnel" class="text-gray-500 hover:text-blue-500 pb-1 px-2">Funnel Health</button>
                    <button onclick="switchTab('roas')" id="tab-roas" class="text-gray-500 hover:text-blue-500 pb-1 px-2">ROAS Scaling</button>
                    <button onclick="switchTab('dow')" id="tab-dow" class="text-gray-500 hover:text-blue-500 pb-1 px-2">Day of Week</button>
                    <button onclick="switchTab('sync')" id="tab-sync" class="text-gray-500 hover:text-blue-500 pb-1 px-2">Data Sync</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4">
        
        <div id="global-filters" class="bg-white p-5 rounded-lg shadow-md border-t-4 border-blue-600 mb-8 flex flex-wrap gap-4 items-start relative z-10">
            <div class="flex flex-col gap-1">
                <label class="text-sm font-bold text-gray-700">From Date</label>
                <input type="date" id="dash-start" class="border rounded p-2 text-sm w-36">
            </div>
            <div class="flex flex-col gap-1">
                <label class="text-sm font-bold text-gray-700">To Date</label>
                <input type="date" id="dash-end" class="border rounded p-2 text-sm w-36">
            </div>
            
            <div class="flex flex-col gap-1">
                <label class="text-sm font-bold text-gray-700">Country / Region Filter</label>
                <select id="dash-country" class="border rounded p-2 text-sm w-56">
                    <option value="ALL">All Locations</option>
                </select>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-sm font-bold text-gray-700">Exclude Ad Sets <span class="text-[10px] text-gray-400 font-normal">(Ctrl/Cmd+Click)</span></label>
                <select id="dash-exclude-adsets" multiple class="border rounded p-2 text-sm w-64 h-20 bg-white shadow-inner"></select>
            </div>

            <div class="flex flex-col gap-1 bg-gray-50 p-3 rounded border min-w-[420px] max-w-lg">
                <label class="text-sm font-bold text-gray-700">Excluded Events / Dates</label>
                <div id="exclude-date-rows" class="flex flex-col gap-1.5 max-h-24 overflow-y-auto pr-1"></div>
                <button onclick="addExcludeRow()" class="text-xs text-blue-600 font-bold hover:underline text-left mt-2 w-max">+ Add Event</button>
            </div>

            <div class="flex flex-col gap-2 ml-auto mt-6 items-end">
                <div class="flex gap-2">
                    <button onclick="openRegionModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded shadow hover:bg-gray-300 transition text-sm font-medium">‚öôÔ∏è Edit Regions</button>
                    <button onclick="refreshAllViews()" id="btn-global-load" class="bg-blue-600 text-white px-6 py-2 rounded shadow hover:bg-blue-700 transition text-sm font-bold">Apply Filters</button>
                </div>
                <div class="text-xs text-gray-400 text-right mt-1">Updates all tabs instantly</div>
            </div>
        </div>

        <div id="view-dashboard">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-xl font-bold text-gray-800">Macro Overview</h2>
                <button onclick="copyForGemini()" id="btn-copy-gemini" class="bg-indigo-100 text-indigo-700 border border-indigo-300 px-4 py-1.5 rounded shadow-sm hover:bg-indigo-200 transition text-sm font-medium">üìã Copy data for Gemini</button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-red-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">Meta Ad Spend</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-spend">‚Ç¨0.00</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">Net Revenue <span class="text-[10px] lowercase text-gray-400 font-normal">(-Steam/Tax)</span></div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-net">‚Ç¨0.00</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">Subscribers</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-subs">0</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-yellow-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">Cost Per Sub</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-cps">‚Ç¨0.00</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-purple-400">
                    <div class="text-xs text-gray-500 font-medium uppercase">ROAS</div>
                    <div class="text-xl font-bold text-gray-800" id="kpi-roas">0.00x</div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-6">
                <canvas id="mainChart" height="80"></canvas>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-10 overflow-x-auto">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Regional Performance Breakdown</h3>
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-sm text-gray-600">
                            <th class="p-3 cursor-pointer" onclick="sortTable('countryName')">Country / Region ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('spend')">Ad Spend ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('net')">Net Revenue ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('subs')">Subscribers ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('cps')">Cost / Sub ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('roas')">ROAS ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('cpm')">CPM ‚Üï</th>
                            <th class="p-3 cursor-pointer text-right" onclick="sortTable('cpc')">CPC ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="country-table-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>

        <div id="view-funnel" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Funnel Health & Action Matrix</h2>
            
            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="flex flex-wrap gap-6 items-start">
                    <div class="flex flex-col gap-3 md:border-r border-gray-200 md:pr-6 w-full md:w-auto">
                        <h3 class="font-bold text-gray-700">Optimizer Targets</h3>
                        <div class="flex gap-4">
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">Target ROAS</label>
                                <input type="number" step="0.1" id="target-roas" class="border rounded p-1.5 text-sm w-20" onchange="saveOptimizerTargets()">
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">Target Cost/Sub</label>
                                <input type="number" step="0.1" id="target-cps" class="border rounded p-1.5 text-sm w-20" onchange="saveOptimizerTargets()">
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">Target CTR %</label>
                                <input type="number" step="0.1" id="target-ctr" class="border rounded p-1.5 text-sm w-20" onchange="saveOptimizerTargets()">
                            </div>
                            <div class="flex flex-col gap-1">
                                <label class="text-[10px] text-gray-500 uppercase font-bold">Target Opt-in %</label>
                                <input type="number" step="1" id="target-optin" class="border rounded p-1.5 text-sm w-20" onchange="saveOptimizerTargets()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-2 flex-1">
                        <h3 class="font-bold text-gray-700">Diagnostic Legend (Automated Actions)</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-2">
                            <div class="bg-green-50 border border-green-300 p-2 rounded text-xs">
                                <span class="font-bold text-green-700">SCALE</span><br>
                                Beating Target ROAS.<br><span class="text-gray-600 font-medium">‚Üí Increase budget!</span>
                            </div>
                            <div class="bg-blue-50 border border-blue-300 p-2 rounded text-xs">
                                <span class="font-bold text-blue-700">REDUCE</span><br>
                                ROAS &gt; 1.0 but &lt; Target.<br><span class="text-gray-600 font-medium">‚Üí Lower budget slightly.</span>
                            </div>
                            <div class="bg-yellow-50 border border-yellow-300 p-2 rounded text-xs">
                                <span class="font-bold text-yellow-700">MONITOR</span><br>
                                Low ROAS, Cheap Subs.<br><span class="text-gray-600 font-medium">‚Üí Wait for emails to buy.</span>
                            </div>
                            <div class="bg-orange-50 border border-orange-300 p-2 rounded text-xs">
                                <span class="font-bold text-orange-700">FIX ADS</span><br>
                                High Cost, Low CTR.<br><span class="text-gray-600 font-medium">‚Üí Renew ad creatives.</span>
                            </div>
                            <div class="bg-red-50 border border-red-300 p-2 rounded text-xs">
                                <span class="font-bold text-red-600">LOW CONVERSION</span><br>
                                Good CTR, Low Opt-in.<br><span class="text-gray-600 font-medium">‚Üí Check landing page.</span>
                            </div>
                            <div class="bg-gray-100 border border-gray-400 p-2 rounded text-xs">
                                <span class="font-bold text-gray-700">BAD LEADS</span><br>
                                Good Funnel, No Sales.<br><span class="text-gray-600 font-medium">‚Üí Kill or Exclude.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-8 overflow-x-auto">
                <h3 class="text-lg font-bold text-gray-800 mb-2">By Country</h3>
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-300 bg-gray-100 text-sm text-gray-700">
                            <th class="p-3 font-bold cursor-pointer" onclick="sortFunnelTable('country', 'sortName')">Country / Region ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortFunnelTable('country', 'spend')">Ad Spend ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('country', 'imp')">Imp. ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('country', 'clicks')">Clicks ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('country', 'ctr')">CTR % ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('country', 'subs')">Subs ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('country', 'optin')">Opt-in % ‚Üï</th>
                            <th class="p-3 text-right font-bold text-gray-800 cursor-pointer" onclick="sortFunnelTable('country', 'cps')">Cost/Sub ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('country', 'net')">Net Rev ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('country', 'revps')">Rev/Sub ‚Üï</th>
                            <th class="p-3 text-right font-bold text-purple-700 cursor-pointer" onclick="sortFunnelTable('country', 'roas')">ROAS ‚Üï</th>
                            <th class="p-3 text-center font-bold">Action</th>
                        </tr>
                    </thead>
                    <tbody id="funnel-country-body" class="text-sm"></tbody>
                </table>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-8 overflow-x-auto">
                <h3 class="text-lg font-bold text-gray-800 mb-2">By Region</h3>
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-300 bg-gray-100 text-sm text-gray-700">
                            <th class="p-3 font-bold cursor-pointer" onclick="sortFunnelTable('region', 'sortName')">Region ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortFunnelTable('region', 'spend')">Ad Spend ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('region', 'imp')">Imp. ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('region', 'clicks')">Clicks ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('region', 'ctr')">CTR % ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('region', 'subs')">Subs ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('region', 'optin')">Opt-in % ‚Üï</th>
                            <th class="p-3 text-right font-bold text-gray-800 cursor-pointer" onclick="sortFunnelTable('region', 'cps')">Cost/Sub ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('region', 'net')">Net Rev ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('region', 'revps')">Rev/Sub ‚Üï</th>
                            <th class="p-3 text-right font-bold text-purple-700 cursor-pointer" onclick="sortFunnelTable('region', 'roas')">ROAS ‚Üï</th>
                            <th class="p-3 text-center font-bold">Action</th>
                        </tr>
                    </thead>
                    <tbody id="funnel-region-body" class="text-sm"></tbody>
                </table>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-10 overflow-x-auto">
                <h3 class="text-lg font-bold text-gray-800 mb-2">By Ad Set</h3>
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-300 bg-gray-100 text-sm text-gray-700">
                            <th class="p-3 font-bold cursor-pointer" onclick="sortFunnelTable('adset', 'sortName')">Ad Set ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortFunnelTable('adset', 'spend')">Ad Spend ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('adset', 'imp')">Imp. ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('adset', 'clicks')">Clicks ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('adset', 'ctr')">CTR % ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('adset', 'subs')">Subs ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('adset', 'optin')">Opt-in % ‚Üï</th>
                            <th class="p-3 text-right font-bold text-gray-800 cursor-pointer" onclick="sortFunnelTable('adset', 'cps')">Cost/Sub ‚Üï</th>
                            <th class="p-3 text-right cursor-pointer" onclick="sortFunnelTable('adset', 'net')">Net Rev ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-700 cursor-pointer" onclick="sortFunnelTable('adset', 'revps')">Rev/Sub ‚Üï</th>
                            <th class="p-3 text-right font-bold text-purple-700 cursor-pointer" onclick="sortFunnelTable('adset', 'roas')">ROAS ‚Üï</th>
                            <th class="p-3 text-center font-bold">Action</th>
                        </tr>
                    </thead>
                    <tbody id="funnel-adset-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>

        <div id="view-roas" class="hidden">
            <div class="flex justify-between items-end mb-4">
                <h2 class="text-xl font-bold text-gray-800">Diminishing Returns (ROAS Scaling)</h2>
                <div class="flex items-center gap-2 bg-white p-2 rounded shadow-sm border">
                    <label class="text-sm font-bold text-gray-700">Grouping:</label>
                    <select id="roas-timeframe" class="border rounded p-1 text-sm bg-gray-50" onchange="loadRoasData()">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly (Mon-Sun)</option>
                    </select>
                </div>
            </div>

            <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded border mb-6">
                *This chart strictly ignores chronological dates. It plots your periods ordered from <strong>Lowest Ad Spend</strong> (left) to <strong>Highest Ad Spend</strong> (right). Look for the point on the X-Axis where the purple ROAS line falls below 1.0x to find your maximum profitable budget.
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-6">
                <canvas id="roasChart" height="100"></canvas>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-10 overflow-x-auto">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-200 bg-gray-50 text-sm text-gray-600">
                            <th class="p-3">Period</th>
                            <th class="p-3 text-right">Ad Spend (Ordered)</th>
                            <th class="p-3 text-right">Net Revenue</th>
                            <th class="p-3 text-right">Subscribers</th>
                            <th class="p-3 text-right">Cost / Sub</th>
                            <th class="p-3 text-right">ROAS</th>
                        </tr>
                    </thead>
                    <tbody id="roas-table-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>

        <div id="view-dow" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Day of Week Performance Matrix</h2>
            <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded border mb-6">
                *Heatmap colors are calculated <strong>vertically</strong> (comparing all rows on the same day). This shows you which entity dominates on a given day of the week.<br>
                *Note: Steam purchases are organic/global and cannot be natively attributed to a specific Meta Ad Set, so Revenue/ROAS will pool into "Unattributed" in the Ad Set table.
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-8 overflow-x-auto">
                <h3 class="text-lg font-bold text-gray-800 mb-2">By Country</h3>
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-300 bg-gray-100 text-sm text-gray-700">
                            <th class="p-3 font-bold cursor-pointer" onclick="sortDowTable('country', -1)">Country ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('country', 0)">Mon ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('country', 1)">Tue ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('country', 2)">Wed ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('country', 3)">Thu ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('country', 4)">Fri ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('country', 5)">Sat ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('country', 6)">Sun ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-800 cursor-pointer" onclick="sortDowTable('country', 7)">Overall ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="dow-country-body" class="text-sm"></tbody>
                </table>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-8 overflow-x-auto">
                <h3 class="text-lg font-bold text-gray-800 mb-2">By Region</h3>
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-300 bg-gray-100 text-sm text-gray-700">
                            <th class="p-3 font-bold cursor-pointer" onclick="sortDowTable('region', -1)">Region ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('region', 0)">Mon ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('region', 1)">Tue ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('region', 2)">Wed ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('region', 3)">Thu ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('region', 4)">Fri ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('region', 5)">Sat ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('region', 6)">Sun ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-800 cursor-pointer" onclick="sortDowTable('region', 7)">Overall ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="dow-region-body" class="text-sm"></tbody>
                </table>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm mb-8 overflow-x-auto">
                <h3 class="text-lg font-bold text-gray-800 mb-2">By Ad Set</h3>
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead>
                        <tr class="border-b-2 border-gray-300 bg-gray-100 text-sm text-gray-700">
                            <th class="p-3 font-bold cursor-pointer" onclick="sortDowTable('adset', -1)">Ad Set ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('adset', 0)">Mon ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('adset', 1)">Tue ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('adset', 2)">Wed ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('adset', 3)">Thu ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('adset', 4)">Fri ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('adset', 5)">Sat ‚Üï</th>
                            <th class="p-3 text-right font-bold cursor-pointer" onclick="sortDowTable('adset', 6)">Sun ‚Üï</th>
                            <th class="p-3 text-right font-bold text-blue-800 cursor-pointer" onclick="sortDowTable('adset', 7)">Overall ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="dow-adset-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>

        <div id="view-sync" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <h2 class="text-lg font-bold mb-4">Manual ETL Triggers</h2>
                <div class="flex gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Fetch Data From:</label>
                        <input type="date" id="since" class="border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">To:</label>
                        <input type="date" id="until" class="border rounded p-2 text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <button onclick="triggerUpdate('refresh')" class="bg-gray-800 text-white py-2 rounded hover:bg-black transition">Update ALL</button>
                    <button onclick="triggerUpdate('fetch-stripe')" class="bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">Stripe</button>
                    <button onclick="triggerUpdate('fetch-meta')" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Meta Ads</button>
                    <button onclick="triggerUpdate('fetch-tiktok')" class="bg-black text-white py-2 rounded hover:bg-gray-800 transition">TikTok Ads</button>
                    <button onclick="triggerUpdate('fetch-mailerlite')" class="bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">MailerLite</button>
                    <button onclick="triggerUpdate('fetch-steam-sales')" class="bg-gray-600 text-white py-2 rounded hover:bg-gray-700 transition">Steam</button>
                </div>
            </div>
            <h3 class="font-bold text-gray-700 mb-2">Terminal Output</h3>
            <div class="console-container mb-10" id="console">
                <div class="log-info">System ready. Awaiting commands...</div>
            </div>
        </div>

    </div>

    <div id="region-modal" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-2">Manage Regions</h3>
            <p class="text-xs text-gray-500 mb-4">Format: <code>Region Name = CC, CC</code>. A country can be in multiple regions.</p>
            <textarea id="region-text" class="w-full border rounded p-2 text-sm font-mono h-40 mb-4" placeholder="DACH = DE, AT, CH&#10;Francophone = FR, BE, CH"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeRegionModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="saveRegions()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save & Reload</button>
            </div>
        </div>
    </div>

    <script>
        // --- Shared Data Cache ---
        let GLOBAL_RAW_DATA = null;
        async function fetchAllSheets(force = false) {
            if (GLOBAL_RAW_DATA && !force) return GLOBAL_RAW_DATA;
            const SHEET_ID = '15zn0MHwsfkG20eBvEQmFb4BdTto2xEM9z2RAKtfgDow';
            
            const fetchSheet = async (name) => new Promise((resolve) => {
                Papa.parse(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${name}`, { 
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => resolve(res.data), error: () => resolve([])
                });
            });

            const [meta, steam, stripe, paypal, mailerlite] = await Promise.all([
                fetchSheet('Meta'), fetchSheet('Steam_Sales'), fetchSheet('Stripe'), fetchSheet('Paypal'), fetchSheet('MailerLite')
            ]);
            GLOBAL_RAW_DATA = { meta, steam, stripe, paypal, mailerlite };
            return GLOBAL_RAW_DATA;
        }

        // --- Core Helpers ---
        const TAX_RATE = 0.125;
        const STEAM_CUT = 0.30;
        const RATES = { 'usd': 0.92, 'eur': 1.0, 'gbp': 1.17, 'jpy': 0.0061, 'krw': 0.00069, 'aud': 0.60, 'cad': 0.68, 'chf': 1.06, 'cny': 0.13, 'brl': 0.18, 'mxn': 0.054, 'inr': 0.011 };
        function toEur(amount, curr) { return amount * (RATES[(curr || 'eur').toLowerCase()] || 1); }

        const regionNames = new Intl.DisplayNames(['en'], { type: 'region' });
        function getCountryName(code) {
            if (!code || code === 'UNKNOWN') return 'Unknown / Unattributed';
            try { return regionNames.of(code) || code; } catch (e) { return code; }
        }

        function normalizeDate(dStr) {
            if (!dStr) return null;
            if (dStr.includes('/')) {
                const parts = dStr.split('/');
                if (parts.length === 3) return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
            }
            return dStr.substring(0, 10);
        }

        function getMonday(dStr) {
            const d = new Date(dStr);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6: 1); 
            const monday = new Date(d.setDate(diff));
            return monday.toISOString().split('T')[0];
        }

        // --- Region Management ---
        let REGIONS = {};
        function loadRegions() {
            const saved = localStorage.getItem('wl-regions') || "DACH = DE, AT, CH\nNorth America = US, CA\nUK = GB, UK\nFrancophone = FR, BE, CH\nHispanophone = ES, MX, AR";
            document.getElementById('region-text').value = saved;
            REGIONS = {}; 
            saved.split('\n').forEach(line => {
                if (!line.includes('=')) return;
                const [regName, codes] = line.split('=');
                codes.split(',').forEach(c => {
                    const cleanCode = c.trim().toUpperCase();
                    if (!REGIONS[cleanCode]) REGIONS[cleanCode] = [];
                    REGIONS[cleanCode].push(regName.trim());
                });
            });
        }
        function openRegionModal() { document.getElementById('region-modal').classList.remove('hidden'); }
        function closeRegionModal() { document.getElementById('region-modal').classList.add('hidden'); }
        function saveRegions() { localStorage.setItem('wl-regions', document.getElementById('region-text').value); closeRegionModal(); loadRegions(); refreshAllViews(); }
        loadRegions();

        // --- Exclude Dates UI & Logic ---
        function loadExcludedDates() {
            const saved = JSON.parse(localStorage.getItem('wl-excludes') || '[]');
            const container = document.getElementById('exclude-date-rows');
            container.innerHTML = '';
            if (saved.length === 0) {
                addExcludeRowDOM();
            } else {
                saved.forEach(item => addExcludeRowDOM(item.id, item.active, item.name, item.start, item.end));
            }
        }

        function addExcludeRowDOM(id = Date.now() + Math.floor(Math.random() * 1000), active = true, name = '', start = '', end = '') {
            const container = document.getElementById('exclude-date-rows');
            const div = document.createElement('div');
            div.id = 'excl-' + id;
            div.className = "flex items-center gap-2 mb-1";
            div.setAttribute('data-exclude-row', 'true');
            div.innerHTML = `
                <input type="checkbox" class="exclude-active cursor-pointer" title="Toggle active" ${active ? 'checked' : ''} onchange="saveExcludedDates()">
                <input type="text" class="exclude-name border rounded p-1 text-xs w-28" placeholder="Name (e.g. Sale)" value="${name}" onchange="saveExcludedDates()" onkeyup="saveExcludedDates()">
                <input type="date" class="exclude-start border rounded p-1 text-xs w-28" value="${start}" onchange="saveExcludedDates()">
                <span class="text-gray-400 text-xs">to</span>
                <input type="date" class="exclude-end border rounded p-1 text-xs w-28" value="${end}" onchange="saveExcludedDates()">
                <button onclick="document.getElementById('excl-${id}').remove(); saveExcludedDates();" class="text-red-500 font-bold px-1.5 hover:bg-red-100 rounded" title="Delete Rule">√ó</button>
            `;
            container.appendChild(div);
        }

        function addExcludeRow() {
            addExcludeRowDOM();
            saveExcludedDates();
        }

        function saveExcludedDates() {
            const ranges = [];
            document.querySelectorAll('[data-exclude-row]').forEach(row => {
                ranges.push({
                    active: row.querySelector('.exclude-active').checked,
                    name: row.querySelector('.exclude-name').value,
                    start: row.querySelector('.exclude-start').value,
                    end: row.querySelector('.exclude-end').value,
                    id: row.id.replace('excl-', '')
                });
            });
            localStorage.setItem('wl-excludes', JSON.stringify(ranges));
        }

        function getExcludedDateRanges() {
            const ranges = [];
            document.querySelectorAll('[data-exclude-row]').forEach(row => {
                const isActive = row.querySelector('.exclude-active').checked;
                if (!isActive) return;
                const s = row.querySelector('.exclude-start').value;
                const e = row.querySelector('.exclude-end').value;
                const n = row.querySelector('.exclude-name').value;
                if (s || e) ranges.push({ name: n, start: s || '2000-01-01', end: e || '2099-12-31' });
            });
            return ranges;
        }

        function isDateExcluded(dStr, excludeRanges) { 
            return excludeRanges.some(r => dStr >= r.start && dStr <= r.end); 
        }

        function getRankColor(val, sortedArr, goodIsHigh) {
            if (!val || val <= 0 || sortedArr.length === 0) return 'transparent';
            if (sortedArr.length === 1) return 'hsl(60, 80%, 85%)'; 
            const index = sortedArr.indexOf(val);
            if (index === -1) return 'transparent';
            let ratio = index / (sortedArr.length - 1); 
            if (!goodIsHigh) ratio = 1 - ratio; 
            return `hsl(${ratio * 120}, 80%, 85%)`; 
        }

        // --- Target Optimizers UI ---
        function loadOptimizerTargets() {
            document.getElementById('target-roas').value = localStorage.getItem('wl-target-roas') || '2.0';
            document.getElementById('target-cps').value = localStorage.getItem('wl-target-cps') || '2.0';
            document.getElementById('target-ctr').value = localStorage.getItem('wl-target-ctr') || '1.0';
            document.getElementById('target-optin').value = localStorage.getItem('wl-target-optin') || '20';
        }
        
        function saveOptimizerTargets() {
            localStorage.setItem('wl-target-roas', document.getElementById('target-roas').value);
            localStorage.setItem('wl-target-cps', document.getElementById('target-cps').value);
            localStorage.setItem('wl-target-ctr', document.getElementById('target-ctr').value);
            localStorage.setItem('wl-target-optin', document.getElementById('target-optin').value);
            renderFunnelTables(); 
        }

        // --- UI Tabs ---
        function switchTab(tab) {
            ['dashboard', 'roas', 'dow', 'funnel', 'sync'].forEach(t => {
                document.getElementById('view-' + t).classList.toggle('hidden', tab !== t);
                const btn = document.getElementById('tab-' + t);
                if(btn) {
                    btn.classList.toggle('text-gray-500', tab !== t);
                    btn.classList.toggle('tab-active', tab === t);
                }
            });
            
            const globalFilters = document.getElementById('global-filters');
            if(globalFilters) {
                globalFilters.classList.toggle('hidden', tab === 'sync');
            }
        }

        // --- UNIFIED MASTER LOAD ---
        let globalDashboardState = {};

        async function refreshAllViews() {
            const btn = document.getElementById('btn-global-load');
            const originalText = btn.innerText;
            btn.innerText = "Loading...";
            btn.disabled = true;

            const raw = await fetchAllSheets();
            if(!raw) { btn.innerText = originalText; btn.disabled = false; return; }

            populateDropdowns(raw);

            globalDashboardState.startDate = document.getElementById('dash-start').value || "2000-01-01";
            globalDashboardState.endDate = document.getElementById('dash-end').value || "2099-12-31";
            globalDashboardState.filterSelection = document.getElementById('dash-country').value;
            globalDashboardState.excludedRanges = getExcludedDateRanges();
            
            const adsetSelect = document.getElementById('dash-exclude-adsets');
            globalDashboardState.excludeAdsets = Array.from(adsetSelect.selectedOptions).map(opt => opt.value);

            loadDashboardData(raw);
            loadFunnelData(raw);
            loadRoasData(raw);
            loadDowData(raw);

            btn.innerText = originalText;
            btn.disabled = false;
        }

        function populateDropdowns(raw) {
            const adsetSelect = document.getElementById('dash-exclude-adsets');
            const selectedAdsets = Array.from(adsetSelect.selectedOptions).map(opt => opt.value);
            const uniqueAdsets = [...new Set(raw.meta.map(r => r.adset_name).filter(Boolean))].sort();
            
            adsetSelect.innerHTML = ''; 
            uniqueAdsets.forEach(adset => {
                const opt = new Option(adset, adset);
                if (selectedAdsets.includes(adset)) opt.selected = true; 
                adsetSelect.add(opt);
            });

            const countrySelect = document.getElementById('dash-country');
            const selectedCountry = countrySelect.value;
            const dropdownOptions = new Set();

            const addOpts = (cCode) => {
                if(!cCode) return;
                const code = cCode.toUpperCase();
                if(code !== 'UNKNOWN') dropdownOptions.add(code);
                const regs = REGIONS[code] || [];
                regs.forEach(r => dropdownOptions.add('REGION:' + r));
            };

            raw.meta.forEach(r => addOpts(r.country));
            raw.steam.forEach(r => addOpts(r.country));
            raw.stripe.forEach(r => addOpts(r.country));
            raw.mailerlite.forEach(r => addOpts(r.country));
            raw.paypal.forEach(r => addOpts(r.country));

            countrySelect.innerHTML = '<option value="ALL">All Locations</option>';
            const regionsList = [], countriesList = [];
            dropdownOptions.forEach(opt => opt.startsWith('REGION:') ? regionsList.push(opt) : countriesList.push(opt));
            
            regionsList.sort().forEach(opt => countrySelect.add(new Option(`üåç ${opt.replace('REGION:', '')} (Region)`, opt)));
            countriesList.sort((a, b) => getCountryName(a).localeCompare(getCountryName(b))).forEach(opt => countrySelect.add(new Option(`üá∫üá≥ ${getCountryName(opt)}`, opt)));
            
            if (Array.from(countrySelect.options).some(o => o.value === selectedCountry)) {
                countrySelect.value = selectedCountry;
            } else {
                countrySelect.value = 'ALL';
            }
        }

        // --- DASHBOARD LOGIC ---
        let myChart = null;
        let countryAggData = []; 
        let currentSort = { col: 'roas', desc: true }; 

        function loadDashboardData(raw) {
            let totalSpend = 0, totalNet = 0, totalSubs = 0, totalImp = 0, totalClicks = 0;
            const dailyData = {}; 
            const countryAgg = {}; 

            const { startDate, endDate, filterSelection, excludeAdsets, excludedRanges } = globalDashboardState;

            const addMetric = (date, metric, val, countryCode) => {
                if (!date || isNaN(val)) return;
                const d = normalizeDate(date);
                const cCode = (countryCode || 'UNKNOWN').toUpperCase();
                const regionNames = REGIONS[cCode] || [];

                let isFilteredIn = false;
                if (filterSelection === 'ALL') isFilteredIn = true;
                else if (filterSelection.startsWith('REGION:')) isFilteredIn = regionNames.includes(filterSelection.replace('REGION:', ''));
                else isFilteredIn = (cCode === filterSelection);

                if (d >= startDate && d <= endDate && isFilteredIn && !isDateExcluded(d, excludedRanges)) {
                    if (!dailyData[d]) dailyData[d] = { spend: 0, net: 0, subs: 0 };
                    dailyData[d][metric] += val;
                    
                    if (!countryAgg[cCode]) countryAgg[cCode] = { country: cCode, countryName: getCountryName(cCode), region: regionNames.length > 0 ? regionNames.join(', ') : 'Other', spend: 0, net: 0, subs: 0, imp: 0, clicks: 0 };
                    countryAgg[cCode][metric] += val;
                    
                    if (metric === 'spend') totalSpend += val;
                    if (metric === 'net') totalNet += val;
                    if (metric === 'subs') totalSubs += val;
                    if (metric === 'imp') totalImp += val;
                    if (metric === 'clicks') totalClicks += val;
                }
            };

            raw.meta.forEach(r => {
                if (!excludeAdsets.includes(r.adset_name || '')) {
                    addMetric(r.date, 'spend', parseFloat(r.spend || 0), r.country);
                    addMetric(r.date, 'imp', parseInt(r.impressions || 0), r.country);
                    addMetric(r.date, 'clicks', parseInt(r.clicks || 0), r.country);
                }
            });
            raw.mailerlite.forEach(r => addMetric(r.created_at, 'subs', 1, r.country));
            raw.steam.forEach(r => addMetric(r.date, 'net', toEur(parseFloat(r.net_revenue || 0), 'usd') * (1 - STEAM_CUT) * (1 - TAX_RATE), r.country));
            raw.stripe.forEach(r => {
                if (r.status !== 'unpaid') {
                    const curr = (r.currency || 'eur').toLowerCase();
                    const amt = ['jpy', 'krw', 'vnd', 'clp', 'pyg'].includes(curr) ? parseFloat(r.amount || 0) : (parseFloat(r.amount || 0) / 100);
                    addMetric(r.created_at, 'net', toEur(amt, curr) * (1 - TAX_RATE), r.country);
                }
            });
            raw.paypal.forEach(r => addMetric(r.date, 'net', toEur(parseFloat(r.amout || r.amount || 0), r.currency) * (1 - TAX_RATE), r.country));

            document.getElementById('kpi-spend').innerText = `‚Ç¨${totalSpend.toFixed(2)}`;
            document.getElementById('kpi-net').innerText = `‚Ç¨${totalNet.toFixed(2)}`;
            document.getElementById('kpi-subs').innerText = totalSubs;
            document.getElementById('kpi-cps').innerText = totalSubs > 0 ? `‚Ç¨${(totalSpend / totalSubs).toFixed(2)}` : '‚Ç¨0.00';
            document.getElementById('kpi-roas').innerText = totalSpend > 0 ? (totalNet / totalSpend).toFixed(2) + 'x' : '0.00x';

            countryAggData = Object.values(countryAgg).map(c => {
                c.cps = c.subs > 0 ? c.spend / c.subs : 0;
                c.roas = c.spend > 0 ? c.net / c.spend : 0;
                c.cpm = c.imp > 0 ? (c.spend / c.imp) * 1000 : 0;
                c.cpc = c.clicks > 0 ? c.spend / c.clicks : 0;
                return c;
            }).filter(c => c.spend > 0 || c.net > 0 || c.subs > 0);
            renderTable();

            const sortedDates = Object.keys(dailyData).sort();
            if (myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [
                        { type: 'bar', label: 'Ad Spend (‚Ç¨)', data: sortedDates.map(d => dailyData[d].spend), backgroundColor: 'rgba(248, 113, 113, 0.7)', yAxisID: 'y' },
                        { type: 'line', label: 'ROAS (x)', data: sortedDates.map(d => dailyData[d].spend > 0 ? (dailyData[d].net / dailyData[d].spend) : 0), borderColor: '#a855f7', backgroundColor: 'rgba(168, 85, 247, 0.1)', fill: false, tension: 0.3, yAxisID: 'y1' },
                        { type: 'line', label: 'Cost / Sub (‚Ç¨)', data: sortedDates.map(d => dailyData[d].subs > 0 ? (dailyData[d].spend / dailyData[d].subs) : 0), borderColor: '#facc15', backgroundColor: 'rgba(250, 204, 21, 0.1)', fill: false, tension: 0.3, yAxisID: 'y1' }
                    ]
                },
                options: { responsive: true, interaction: { mode: 'index', intersect: false }, scales: { y: { type: 'linear', position: 'left' }, y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } } } }
            });

            globalDashboardState.totalSpend = totalSpend; globalDashboardState.totalNet = totalNet; globalDashboardState.totalSubs = totalSubs; globalDashboardState.totalImp = totalImp; globalDashboardState.totalClicks = totalClicks;
        }

        function sortTable(col) {
            if (currentSort.col === col) currentSort.desc = !currentSort.desc;
            else { currentSort.col = col; currentSort.desc = true; }
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('country-table-body');
            const col = currentSort.col;
            const dir = currentSort.desc ? -1 : 1;

            countryAggData.sort((a, b) => {
                if (typeof a[col] === 'string') return a[col].localeCompare(b[col]) * dir;
                return (a[col] > b[col] ? 1 : -1) * dir;
            });

            const sRoas = countryAggData.filter(c => c.roas > 0).map(c => c.roas).sort((a,b) => a - b);
            const sCps = countryAggData.filter(c => c.cps > 0).map(c => c.cps).sort((a,b) => a - b);
            const sCpm = countryAggData.filter(c => c.cpm > 0).map(c => c.cpm).sort((a,b) => a - b);
            const sCpc = countryAggData.filter(c => c.cpc > 0).map(c => c.cpc).sort((a,b) => a - b);

            tbody.innerHTML = countryAggData.map(c => `
                <tr class="border-b transition hover:bg-gray-100">
                    <td class="p-3 text-gray-800"><span class="font-medium">${c.countryName}</span> <span class="text-xs text-gray-400 ml-1">(${c.country})</span> ${c.region !== 'Other' ? `<span class="text-xs text-blue-500 font-bold ml-1">[${c.region}]</span>` : ''}</td>
                    <td class="p-3 text-right text-red-600">‚Ç¨${c.spend.toFixed(2)}</td>
                    <td class="p-3 text-right text-green-600">‚Ç¨${c.net.toFixed(2)}</td>
                    <td class="p-3 text-right text-blue-600 font-bold">${c.subs}</td>
                    <td class="p-3 text-right text-gray-800 font-medium" style="background-color: ${c.subs > 0 ? getRankColor(c.cps, sCps, false) : 'transparent'}">‚Ç¨${c.cps.toFixed(2)}</td>
                    <td class="p-3 text-right text-gray-800 font-bold" style="background-color: ${getRankColor(c.roas, sRoas, true)}">${c.roas.toFixed(2)}x</td>
                    <td class="p-3 text-right text-gray-600 text-xs" style="background-color: ${c.imp > 0 ? getRankColor(c.cpm, sCpm, false) : 'transparent'}">‚Ç¨${c.cpm.toFixed(2)}</td>
                    <td class="p-3 text-right text-gray-600 text-xs" style="background-color: ${c.clicks > 0 ? getRankColor(c.cpc, sCpc, false) : 'transparent'}">‚Ç¨${c.cpc.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        // --- FUNNEL HEALTH & OPTIMIZER TAB LOGIC ---
        let funnelData = { country: [], region: [], adset: [], global: null };
        let funnelSort = { country: { col: 'spend', desc: true }, region: { col: 'spend', desc: true }, adset: { col: 'spend', desc: true } };

        function loadFunnelData(raw) {
            const { startDate, endDate, filterSelection, excludeAdsets, excludedRanges } = globalDashboardState;

            const aggC = {}, aggR = {}, aggA = {};
            const gTot = { spend: 0, imp: 0, clicks: 0, subs: 0, net: 0 };

            const addMetric = (date, metric, val, countryCode, adsetName) => {
                if (!date || isNaN(val)) return;
                const d = normalizeDate(date);
                if (d < startDate || d > endDate || isDateExcluded(d, excludedRanges)) return;

                const cCode = (countryCode || 'UNKNOWN').toUpperCase();
                const regionNames = REGIONS[cCode] || [];
                const safeAdset = adsetName || 'Unattributed';

                let isFilteredIn = false;
                if (filterSelection === 'ALL') isFilteredIn = true;
                else if (filterSelection.startsWith('REGION:')) isFilteredIn = regionNames.includes(filterSelection.replace('REGION:', ''));
                else isFilteredIn = (cCode === filterSelection);

                if (!isFilteredIn) return;

                if (!aggC[cCode]) aggC[cCode] = { 
                    name: getCountryName(cCode) + ` <span class="text-xs text-gray-400">(${cCode})</span>` + (regionNames.length > 0 ? ` <span class="text-[10px] text-blue-500 font-bold ml-1">[${regionNames.join(', ')}]</span>` : ''), 
                    sortName: getCountryName(cCode), spend: 0, imp: 0, clicks: 0, subs: 0, net: 0 
                };
                aggC[cCode][metric] += val;

                const regionsToCredit = regionNames.length > 0 ? regionNames : ['Other'];
                regionsToCredit.forEach(reg => {
                    if (!aggR[reg]) aggR[reg] = { name: reg, sortName: reg, spend: 0, imp: 0, clicks: 0, subs: 0, net: 0 };
                    aggR[reg][metric] += val;
                });

                if (!aggA[safeAdset]) aggA[safeAdset] = { name: safeAdset, sortName: safeAdset, spend: 0, imp: 0, clicks: 0, subs: 0, net: 0 };
                aggA[safeAdset][metric] += val;

                gTot[metric] += val;
            };

            raw.meta.forEach(r => {
                if (!excludeAdsets.includes(r.adset_name || '')) {
                    addMetric(r.date, 'spend', parseFloat(r.spend || 0), r.country, r.adset_name);
                    addMetric(r.date, 'imp', parseInt(r.impressions || 0), r.country, r.adset_name);
                    addMetric(r.date, 'clicks', parseInt(r.clicks || 0), r.country, r.adset_name);
                }
            });
            raw.mailerlite.forEach(r => addMetric(r.created_at, 'subs', 1, r.country, null));
            raw.steam.forEach(r => addMetric(r.date, 'net', toEur(parseFloat(r.net_revenue || 0), 'usd') * (1 - STEAM_CUT) * (1 - TAX_RATE), r.country, null));
            raw.stripe.forEach(r => {
                if (r.status !== 'unpaid') {
                    const curr = (r.currency || 'eur').toLowerCase();
                    const amt = ['jpy', 'krw', 'vnd', 'clp', 'pyg'].includes(curr) ? parseFloat(r.amount || 0) : (parseFloat(r.amount || 0) / 100);
                    addMetric(r.created_at, 'net', toEur(amt, curr) * (1 - TAX_RATE), r.country, null);
                }
            });
            raw.paypal.forEach(r => addMetric(r.date, 'net', toEur(parseFloat(r.amout || r.amount || 0), r.currency) * (1 - TAX_RATE), r.country, null));

            const calcFunnel = (c) => {
                c.ctr = c.imp > 0 ? (c.clicks / c.imp) * 100 : 0;
                c.optin = c.clicks > 0 ? (c.subs / c.clicks) * 100 : 0;
                c.revps = c.subs > 0 ? (c.net / c.subs) : 0;
                c.cps = c.subs > 0 ? (c.spend / c.subs) : (c.spend > 0 ? Infinity : 0);
                c.roas = c.spend > 0 ? (c.net / c.spend) : 0;
                return c;
            };

            funnelData.country = Object.values(aggC).map(calcFunnel).filter(c => c.spend > 0 || c.net > 0 || c.subs > 0 || c.imp > 0);
            funnelData.region = Object.values(aggR).map(calcFunnel).filter(c => c.spend > 0 || c.net > 0 || c.subs > 0 || c.imp > 0);
            funnelData.adset = Object.values(aggA).map(calcFunnel).filter(c => c.spend > 0 || c.net > 0 || c.subs > 0 || c.imp > 0);
            
            funnelData.global = calcFunnel(gTot);
            renderFunnelTables();
        }

        function sortFunnelTable(type, col) {
            if (funnelSort[type].col === col) funnelSort[type].desc = !funnelSort[type].desc;
            else { funnelSort[type].col = col; funnelSort[type].desc = true; }
            renderFunnelTables();
        }

        function renderFunnelTables() {
            const targetRoas = parseFloat(document.getElementById('target-roas').value) || 2.0;
            const targetCps = parseFloat(document.getElementById('target-cps').value) || 2.0;
            const targetCtr = parseFloat(document.getElementById('target-ctr').value) || 1.0;
            const targetOptin = parseFloat(document.getElementById('target-optin').value) || 20.0;

            ['country', 'region', 'adset'].forEach(type => {
                const arr = funnelData[type];
                const tbody = document.getElementById(`funnel-${type}-body`);
                if (!arr || arr.length === 0) {
                    tbody.innerHTML = '';
                    return;
                }

                const sortDef = funnelSort[type];
                const dir = sortDef.desc ? -1 : 1;

                arr.sort((a, b) => {
                    if (typeof a[sortDef.col] === 'string') return a[sortDef.col].localeCompare(b[sortDef.col]) * dir;
                    return (a[sortDef.col] > b[sortDef.col] ? 1 : -1) * dir;
                });

                let html = '';

                if (type === 'country' && funnelData.global) {
                    const g = funnelData.global;
                    html += `
                        <tr class="border-b-2 border-gray-400 bg-gray-100 font-bold">
                            <td class="p-3 text-gray-800">GLOBAL AVERAGE</td>
                            <td class="p-3 text-right">‚Ç¨${g.spend.toFixed(2)}</td>
                            <td class="p-3 text-right">${g.imp.toLocaleString()}</td>
                            <td class="p-3 text-right">${g.clicks.toLocaleString()}</td>
                            <td class="p-3 text-right text-blue-800">${g.ctr.toFixed(2)}%</td>
                            <td class="p-3 text-right">${g.subs.toLocaleString()}</td>
                            <td class="p-3 text-right text-blue-800">${g.optin.toFixed(2)}%</td>
                            <td class="p-3 text-right">‚Ç¨${g.cps === Infinity ? '‚àû' : g.cps.toFixed(2)}</td>
                            <td class="p-3 text-right">‚Ç¨${g.net.toFixed(2)}</td>
                            <td class="p-3 text-right text-blue-800">‚Ç¨${g.revps.toFixed(2)}</td>
                            <td class="p-3 text-right text-purple-800">${g.roas.toFixed(2)}x</td>
                            <td class="p-3 text-center">-</td>
                        </tr>
                    `;
                }

                html += arr.map(c => {
                    let bgClass = 'hover:bg-gray-50';
                    let actionBadge = '-';
                    
                    if (c.spend > 0) {
                        const isGoodRoas = c.roas >= targetRoas;
                        const isProfitable = c.roas >= 1.0;
                        const isCheapSub = c.cps <= targetCps; // Infinity = false
                        const isLowCtr = c.ctr < targetCtr;
                        const isLowOptin = c.optin < targetOptin;

                        if (isGoodRoas) {
                            bgClass = 'bg-green-50 hover:bg-green-100';
                            actionBadge = '<span class="px-2 py-1 bg-green-200 text-green-800 rounded text-[10px] font-bold shadow-sm">SCALE</span>';
                        } else if (isProfitable) {
                            bgClass = 'bg-blue-50 hover:bg-blue-100';
                            actionBadge = '<span class="px-2 py-1 bg-blue-200 text-blue-800 rounded text-[10px] font-bold shadow-sm">REDUCE</span>';
                        } else if (isCheapSub) {
                            bgClass = 'bg-yellow-50 hover:bg-yellow-100';
                            actionBadge = '<span class="px-2 py-1 bg-yellow-200 text-yellow-800 rounded text-[10px] font-bold shadow-sm">MONITOR</span>';
                        } else if (isLowCtr) {
                            bgClass = 'bg-orange-50 hover:bg-orange-100';
                            actionBadge = '<span class="px-2 py-1 bg-orange-200 text-orange-800 rounded text-[10px] font-bold shadow-sm">FIX ADS</span>';
                        } else if (isLowOptin) {
                            bgClass = 'bg-red-50 hover:bg-red-100';
                            actionBadge = '<span class="px-2 py-1 bg-red-200 text-red-800 rounded text-[10px] font-bold shadow-sm">FIX PAGE</span>';
                        } else {
                            bgClass = 'bg-gray-100 hover:bg-gray-200';
                            actionBadge = '<span class="px-2 py-1 bg-gray-300 text-gray-800 rounded text-[10px] font-bold shadow-sm">BAD LEADS</span>';
                        }
                    }

                    return `
                        <tr class="border-b transition ${bgClass}">
                            <td class="p-3 text-gray-800 font-medium truncate max-w-[200px]" title="${c.sortName}">${c.name}</td>
                            <td class="p-3 text-right">‚Ç¨${c.spend.toFixed(2)}</td>
                            <td class="p-3 text-right text-gray-600">${c.imp.toLocaleString()}</td>
                            <td class="p-3 text-right text-gray-600">${c.clicks.toLocaleString()}</td>
                            <td class="p-3 text-right text-blue-800 font-medium">${c.ctr.toFixed(2)}%</td>
                            <td class="p-3 text-right text-gray-600">${c.subs.toLocaleString()}</td>
                            <td class="p-3 text-right text-blue-800 font-medium">${c.optin.toFixed(2)}%</td>
                            <td class="p-3 text-right text-gray-800 font-medium">${c.cps === Infinity ? '‚àû' : '‚Ç¨' + c.cps.toFixed(2)}</td>
                            <td class="p-3 text-right text-green-600">‚Ç¨${c.net.toFixed(2)}</td>
                            <td class="p-3 text-right text-blue-800 font-medium">‚Ç¨${c.revps.toFixed(2)}</td>
                            <td class="p-3 text-right text-purple-700 font-bold">${c.roas.toFixed(2)}x</td>
                            <td class="p-3 text-center">${actionBadge}</td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = html;
            });
        }

        // --- ROAS SCALING TAB LOGIC ---
        let roasChart = null;
        function loadRoasData(rawObj) {
            const raw = rawObj || GLOBAL_RAW_DATA;
            if(!raw) return;

            const timeframe = document.getElementById('roas-timeframe').value; 
            const { startDate, endDate, filterSelection, excludeAdsets, excludedRanges } = globalDashboardState;

            const aggregated = {};
            const addMetric = (date, metric, val, countryCode) => {
                if (!date || isNaN(val)) return;
                const d = normalizeDate(date);
                const cCode = (countryCode || 'UNKNOWN').toUpperCase();
                const regionNames = REGIONS[cCode] || [];

                let isFilteredIn = false;
                if (filterSelection === 'ALL') isFilteredIn = true;
                else if (filterSelection.startsWith('REGION:')) isFilteredIn = regionNames.includes(filterSelection.replace('REGION:', ''));
                else isFilteredIn = (cCode === filterSelection);

                if (d >= startDate && d <= endDate && isFilteredIn && !isDateExcluded(d, excludedRanges)) {
                    const periodKey = timeframe === 'weekly' ? getMonday(d) : d;
                    if (!aggregated[periodKey]) aggregated[periodKey] = { period: periodKey, spend: 0, net: 0, subs: 0 };
                    aggregated[periodKey][metric] += val;
                }
            };

            raw.meta.forEach(r => { if (!excludeAdsets.includes(r.adset_name || '')) addMetric(r.date, 'spend', parseFloat(r.spend || 0), r.country); });
            raw.mailerlite.forEach(r => addMetric(r.created_at, 'subs', 1, r.country));
            raw.steam.forEach(r => addMetric(r.date, 'net', toEur(parseFloat(r.net_revenue || 0), 'usd') * (1 - STEAM_CUT) * (1 - TAX_RATE), r.country));
            raw.stripe.forEach(r => {
                if (r.status !== 'unpaid') {
                    const curr = (r.currency || 'eur').toLowerCase();
                    const amt = ['jpy', 'krw', 'vnd', 'clp', 'pyg'].includes(curr) ? parseFloat(r.amount || 0) : (parseFloat(r.amount || 0) / 100);
                    addMetric(r.created_at, 'net', toEur(amt, curr) * (1 - TAX_RATE), r.country);
                }
            });
            raw.paypal.forEach(r => addMetric(r.date, 'net', toEur(parseFloat(r.amout || r.amount || 0), r.currency) * (1 - TAX_RATE), r.country));

            const roasArr = Object.values(aggregated).map(p => {
                p.roas = p.spend > 0 ? p.net / p.spend : 0;
                p.cps = p.subs > 0 ? p.spend / p.subs : 0;
                return p;
            }).filter(p => p.spend > 0).sort((a, b) => a.spend - b.spend);

            document.getElementById('roas-table-body').innerHTML = roasArr.map(p => `
                <tr class="border-b transition hover:bg-gray-100">
                    <td class="p-3 font-medium text-gray-800">${timeframe === 'weekly' ? 'Week of ' + p.period : p.period}</td>
                    <td class="p-3 text-right text-red-600 font-bold">‚Ç¨${p.spend.toFixed(2)}</td>
                    <td class="p-3 text-right text-green-600">‚Ç¨${p.net.toFixed(2)}</td>
                    <td class="p-3 text-right text-blue-600">${p.subs}</td>
                    <td class="p-3 text-right text-gray-800">‚Ç¨${p.cps.toFixed(2)}</td>
                    <td class="p-3 text-right text-gray-800 font-bold">${p.roas.toFixed(2)}x</td>
                </tr>
            `).join('');

            if (roasChart) roasChart.destroy();
            roasChart = new Chart(document.getElementById('roasChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: roasArr.map(p => (timeframe === 'weekly' ? 'Wk: ' : '') + p.period),
                    datasets: [
                        { type: 'bar', label: 'Ad Spend (‚Ç¨)', data: roasArr.map(p => p.spend), backgroundColor: 'rgba(248, 113, 113, 0.5)', yAxisID: 'y' },
                        { type: 'line', label: 'ROAS (x)', data: roasArr.map(p => p.roas), borderColor: '#a855f7', backgroundColor: '#a855f7', fill: false, tension: 0.1, yAxisID: 'y1' }
                    ]
                },
                options: { responsive: true, interaction: { mode: 'index', intersect: false }, scales: { y: { type: 'linear', position: 'left' }, y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false } } } }
            });
        }

        // --- DAY OF WEEK TAB LOGIC ---
        let dowData = { country: [], region: [], adset: [], global: null };
        let dowSort = { country: { col: 7, desc: true }, region: { col: 7, desc: true }, adset: { col: 7, desc: true } };

        function loadDowData(raw) {
            const { startDate, endDate, filterSelection, excludeAdsets, excludedRanges } = globalDashboardState;

            const aggC = {}, aggR = {}, aggA = {};
            const globalDays = Array(7).fill(0).map(() => ({ spend: 0, net: 0 }));
            const globalTotal = { spend: 0, net: 0 };

            const createEmptyAgg = (name) => ({ name, days: Array(7).fill(0).map(()=>({spend:0, net:0, roas:0})), total: {spend:0, net:0, roas:0} });

            const addMetric = (date, metric, val, cCode, adsetName) => {
                if (!date || isNaN(val)) return;
                const d = normalizeDate(date);
                if (d < startDate || d > endDate || isDateExcluded(d, excludedRanges)) return;

                const cleanCode = (cCode || 'UNKNOWN').toUpperCase();
                const regionNames = REGIONS[cleanCode] || [];
                const safeAdset = adsetName || 'Unattributed';

                let isFilteredIn = false;
                if (filterSelection === 'ALL') isFilteredIn = true;
                else if (filterSelection.startsWith('REGION:')) isFilteredIn = regionNames.includes(filterSelection.replace('REGION:', ''));
                else isFilteredIn = (cleanCode === filterSelection);

                if (!isFilteredIn) return;

                const dayIdx = (new Date(d).getDay() + 6) % 7; 

                if (!aggC[cleanCode]) aggC[cleanCode] = createEmptyAgg(getCountryName(cleanCode) + ` (${cleanCode})`);
                aggC[cleanCode].days[dayIdx][metric] += val;
                aggC[cleanCode].total[metric] += val;

                const regionsToCredit = regionNames.length > 0 ? regionNames : ['Other'];
                regionsToCredit.forEach(reg => {
                    if (!aggR[reg]) aggR[reg] = createEmptyAgg(reg);
                    aggR[reg].days[dayIdx][metric] += val;
                    aggR[reg].total[metric] += val;
                });

                if (!aggA[safeAdset]) aggA[safeAdset] = createEmptyAgg(safeAdset);
                aggA[safeAdset].days[dayIdx][metric] += val;
                aggA[safeAdset].total[metric] += val;

                globalDays[dayIdx][metric] += val;
                globalTotal[metric] += val;
            };

            raw.meta.forEach(r => {
                if (!excludeAdsets.includes(r.adset_name || '')) addMetric(r.date, 'spend', parseFloat(r.spend || 0), r.country, r.adset_name);
            });
            raw.steam.forEach(r => addMetric(r.date, 'net', toEur(parseFloat(r.net_revenue || 0), 'usd') * (1 - STEAM_CUT) * (1 - TAX_RATE), r.country, null));
            raw.stripe.forEach(r => {
                if (r.status !== 'unpaid') {
                    const curr = (r.currency || 'eur').toLowerCase();
                    const amt = ['jpy', 'krw', 'vnd', 'clp', 'pyg'].includes(curr) ? parseFloat(r.amount || 0) : (parseFloat(r.amount || 0) / 100);
                    addMetric(r.created_at, 'net', toEur(amt, curr) * (1 - TAX_RATE), r.country, null);
                }
            });
            raw.paypal.forEach(r => addMetric(r.date, 'net', toEur(parseFloat(r.amout || r.amount || 0), r.currency) * (1 - TAX_RATE), r.country, null));

            const calcRoas = (item) => {
                item.days.forEach(d => d.roas = d.spend > 0 ? d.net / d.spend : 0);
                item.total.roas = item.total.spend > 0 ? item.total.net / item.total.spend : 0;
                return item;
            };

            dowData.country = Object.values(aggC).map(calcRoas).filter(c => c.total.spend > 0);
            dowData.region = Object.values(aggR).map(calcRoas).filter(c => c.total.spend > 0);
            dowData.adset = Object.values(aggA).map(calcRoas).filter(c => c.total.spend > 0);
            
            globalDays.forEach(d => d.roas = d.spend > 0 ? d.net / d.spend : 0);
            globalTotal.roas = globalTotal.spend > 0 ? globalTotal.net / globalTotal.spend : 0;
            dowData.global = { days: globalDays, total: globalTotal };

            renderDowTables();
        }

        function sortDowTable(type, colIdx) {
            if (dowSort[type].col === colIdx) dowSort[type].desc = !dowSort[type].desc;
            else { dowSort[type].col = colIdx; dowSort[type].desc = true; }
            renderDowTables();
        }

        function renderDowTables() {
            ['country', 'region', 'adset'].forEach(type => {
                const arr = dowData[type];
                if (!arr || arr.length === 0) {
                    document.getElementById(`dow-${type}-body`).innerHTML = '';
                    return;
                }

                const sortDef = dowSort[type];
                const dir = sortDef.desc ? -1 : 1;

                arr.sort((a, b) => {
                    let valA, valB;
                    if (sortDef.col === -1) { valA = a.name; valB = b.name; }
                    else if (sortDef.col === 7) { valA = a.total.roas; valB = b.total.roas; }
                    else { valA = a.days[sortDef.col].roas; valB = b.days[sortDef.col].roas; }

                    if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
                    return (valA - valB) * dir;
                });

                const sortedCols = [];
                for (let i = 0; i < 7; i++) sortedCols[i] = arr.map(r => r.days[i].roas).filter(v => v > 0).sort((x,y) => x - y);
                const sortedTotal = arr.map(r => r.total.roas).filter(v => v > 0).sort((x,y) => x - y);

                const tbody = document.getElementById(`dow-${type}-body`);
                let html = '';

                if (type === 'country' && dowData.global) {
                    const g = dowData.global;
                    const gSorted = g.days.map(d => d.roas).filter(v => v > 0).sort((x,y) => x - y);
                    html += `<tr class="border-b-2 border-gray-400 bg-gray-100 font-bold">
                        <td class="p-3 text-gray-800">GLOBAL AVERAGE</td>
                        ${g.days.map(d => `<td class="p-3 text-right" style="background-color: ${getRankColor(d.roas, gSorted, true)}">${d.roas > 0 ? d.roas.toFixed(2) + 'x' : '-'}<br><span class="text-[10px] font-normal text-gray-500">‚Ç¨${d.spend.toFixed(0)}</span></td>`).join('')}
                        <td class="p-3 text-right text-blue-800">${g.total.roas.toFixed(2)}x<br><span class="text-[10px] font-normal text-gray-500">‚Ç¨${g.total.spend.toFixed(0)}</span></td>
                    </tr>`;
                }

                html += arr.map(row => `
                    <tr class="border-b transition hover:bg-gray-50">
                        <td class="p-3 text-gray-800 font-medium truncate max-w-[200px]" title="${row.name}">${row.name}</td>
                        ${row.days.map((d, i) => `<td class="p-3 text-right font-medium" style="background-color: ${getRankColor(d.roas, sortedCols[i], true)}">${d.roas > 0 ? d.roas.toFixed(2) + 'x' : '-'}<br><span class="text-[10px] text-gray-400 font-normal">‚Ç¨${d.spend.toFixed(0)}</span></td>`).join('')}
                        <td class="p-3 text-right font-bold text-blue-800" style="background-color: ${getRankColor(row.total.roas, sortedTotal, true)}">${row.total.roas > 0 ? row.total.roas.toFixed(2) + 'x' : '-'}<br><span class="text-[10px] font-normal text-gray-500">‚Ç¨${row.total.spend.toFixed(0)}</span></td>
                    </tr>
                `).join('');

                tbody.innerHTML = html;
            });
        }

        // --- Export & Init Logic ---
        function copyForGemini() {
            const btn = document.getElementById('btn-copy-gemini');
            
            // Format exclusions to include the custom name
            const exDates = globalDashboardState.excludedRanges.map(r => `${r.name ? r.name + ' (' : ''}${r.start} to ${r.end}${r.name ? ')' : ''}`).join(', ') || 'None';
            const exAds = globalDashboardState.excludeAdsets.join(', ') || 'None';
            
            const cps = globalDashboardState.totalSubs > 0 ? (globalDashboardState.totalSpend / globalDashboardState.totalSubs).toFixed(2) : '0.00';
            const roas = globalDashboardState.totalSpend > 0 ? (globalDashboardState.totalNet / globalDashboardState.totalSpend).toFixed(2) : '0.00';
            const globalCpm = globalDashboardState.totalImp > 0 ? (globalDashboardState.totalSpend / globalDashboardState.totalImp) * 1000 : 0;
            const globalCpc = globalDashboardState.totalClicks > 0 ? globalDashboardState.totalSpend / globalDashboardState.totalClicks : 0;

            let output = `## WonderLang Ad Spend & Revenue Analysis\n\n### Dashboard Filter State\n- **Date Range:** ${globalDashboardState.startDate} to ${globalDashboardState.endDate}\n- **Excluded Dates:** ${exDates}\n- **Excluded Ad Sets:** ${exAds}\n- **Country Filter:** ${globalDashboardState.filterSelection}\n\n### Top-Level KPIs\n- **Total Ad Spend:** ‚Ç¨${globalDashboardState.totalSpend.toFixed(2)}\n- **Total Net Revenue:** ‚Ç¨${globalDashboardState.totalNet.toFixed(2)}\n- **New Subscribers:** ${globalDashboardState.totalSubs}\n- **Cost per Sub:** ‚Ç¨${cps}\n- **ROAS:** ${roas}x\n- **Global CPM:** ‚Ç¨${globalCpm.toFixed(2)}\n- **Global CPC:** ‚Ç¨${globalCpc.toFixed(2)}\n\n### Regional Performance Breakdown\n| Country | Region | Ad Spend (‚Ç¨) | Net Rev (‚Ç¨) | Subs | Cost/Sub (‚Ç¨) | ROAS (x) | CPM (‚Ç¨) | CPC (‚Ç¨) |\n|---------|--------|--------------|-------------|------|--------------|----------|---------|---------|\n`;
            countryAggData.forEach(c => output += `| ${c.countryName} (${c.country}) | ${c.region} | ${c.spend.toFixed(2)} | ${c.net.toFixed(2)} | ${c.subs} | ${c.cps.toFixed(2)} | ${c.roas.toFixed(2)} | ${c.cpm.toFixed(2)} | ${c.cpc.toFixed(2)} |\n`);

            navigator.clipboard.writeText(output).then(() => {
                const oldText = btn.innerText; btn.innerText = "‚úÖ Copied to clipboard!";
                btn.classList.replace('bg-indigo-100', 'bg-green-100'); btn.classList.replace('text-indigo-700', 'text-green-700');
                setTimeout(() => { btn.innerText = oldText; btn.classList.replace('bg-green-100', 'bg-indigo-100'); btn.classList.replace('text-green-700', 'text-indigo-700'); }, 3000);
            });
        }

        window.onload = () => {
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setDate(today.getDate() - 30);
            document.getElementById('dash-end').value = today.toISOString().split('T')[0];
            document.getElementById('dash-start').value = lastMonth.toISOString().split('T')[0];
            
            loadExcludedDates();
            loadOptimizerTargets();
            refreshAllViews();
        };

        // --- ETL Sync Logic ---
        function logToConsole(msg, type = 'info') {
            const c = document.getElementById('console');
            const d = document.createElement('div'); d.className = `log-${type}`;
            d.innerText = `[${new Date().toLocaleTimeString()}] ${typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg}`;
            c.appendChild(d); c.scrollTop = c.scrollHeight;
        }

        async function triggerUpdate(endpoint) {
            const btns = document.querySelectorAll('#view-sync button');
            btns.forEach(b => b.disabled = true);
            logToConsole(`>>> Starting ${endpoint.toUpperCase()}...`, 'warn');
            try {
                const res = await fetch(`/.netlify/functions/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ since: document.getElementById('since').value || undefined, until: document.getElementById('until').value || undefined }) });
                const json = await res.json();
                if (res.ok) {
                    if (json.logs) json.logs.forEach(l => logToConsole(l.msg, l.type));
                    if (endpoint === 'refresh' && json.results) Object.entries(json.results).forEach(([src, data]) => logToConsole(`[${src.toUpperCase()}] ${data?.ok === false ? 'ERROR: ' + data.msg : 'SUCCESS: Added ' + (data?.rows||0)}`, data?.ok === false ? 'error' : 'success'));
                    else logToConsole(json.ok === false ? `ERROR: ${json.msg}` : `SUCCESS: Transferred ${json.rows || 0} rows.`, json.ok === false ? 'error' : 'success');
                } else logToConsole(`HTTP ERROR: ${json.error || res.statusText}`, 'error');
            } catch (err) { logToConsole(`NETWORK ERROR: ${err.message}`, 'error'); } 
            finally { btns.forEach(b => b.disabled = false); logToConsole(`<<< ${endpoint.toUpperCase()} finished.`, 'warn'); }
        }
    </script>
</body>
</html>
